name: "Build Docker CI Images"

on:
  workflow_dispatch

jobs:
  build-images:
    name: "Build ${{ matrix.image }} (${{ matrix.platform }})"
    runs-on: ${{ matrix.platform == 'arm64' && 'ubuntu-24.04-arm' || 'ubuntu-24.04' }}
    strategy:
      matrix:
        include:
          - platform: amd64
            image: rpm-repo-builder
            context: packaging/rpm/docker/rpm-repo-builder
          - platform: arm64
            image: rpm-repo-builder
            context: packaging/rpm/docker/rpm-repo-builder
          - platform: amd64
            image: ice-rpm-builder-rhel9
            context: packaging/rpm/docker/rhel9
          - platform: arm64
            image: ice-rpm-builder-rhel9
            context: packaging/rpm/docker/rhel9
          - platform: amd64
            image: ice-rpm-builder-amzn2023
            context: packaging/rpm/docker/amzn2023
          - platform: arm64
            image: ice-rpm-builder-amzn2023
            context: packaging/rpm/docker/amzn2023
            # We don't build rhel10 images here because we need to register with subscription-manager

    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          path: ice

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: zeroc-ice
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        run: |
          docker buildx build \
            --platform linux/${{ matrix.platform }} \
            --tag ghcr.io/zeroc-ice/${{ matrix.image }}:${{ matrix.platform }} \
            --push \
            -f Dockerfile .
        working-directory: ice/${{ matrix.context }}

  create-manifests:
    name: "Create and Push Multi-Arch Manifests"
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        image:
          - rpm-repo-builder
          - ice-rpm-builder-rhel9
          - ice-rpm-builder-amzn2023

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: zeroc-ice
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push manifest
        run: |
          docker manifest create ghcr.io/zeroc-ice/${{ matrix.image }}:latest \
            --amend ghcr.io/zeroc-ice/${{ matrix.image }}:amd64 \
            --amend ghcr.io/zeroc-ice/${{ matrix.image }}:arm64

          docker manifest push ghcr.io/zeroc-ice/${{ matrix.image }}:latest
